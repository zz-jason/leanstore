name: CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  thread-mode:
    runs-on: ubuntu-latest
    container:
      image: zzjason/leanstore-dev:latest
    name: UT [Thread-Mode]
    steps:
    - name: Check out repository
      uses: actions/checkout@v3

    - name: Config project
      run: |
        which vcpkg;
        cmake --preset debug_tsan

    - name: Cppcheck
      run: cppcheck --project=build/debug_tsan/compile_commands.json -i tests --error-exitcode=1 --check-level=exhaustive

    - name: Clang-format
      run: cmake --build build/debug_tsan --target=check-format

    - name: Build
      run: cmake --build build/debug_tsan -j `nproc`

    - name: Unit test with tsan
      run: TSAN_OPTIONS="suppressions=$(pwd)/tests/tsan.supp" ctest --test-dir build/debug_tsan --output-on-failure -j 2

    - name: Generate coverage file
      run: gcovr -v -r . --xml-pretty --xml=coverage.xml --exclude 'build/*' --exclude 'tests/*' --exclude 'benchmarks/*' --verbose

    - name: Upload coverage reports to Codecov
      uses: codecov/codecov-action@v4
      with:
        fail_ci_if_error: true
        files: coverage.xml
        verbose: true
      env:
        CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  coro-mode:
    runs-on: ubuntu-latest
    container:
      image: zzjason/leanstore-dev:latest
    name: UT [Coroutine-Mode]
    steps:
    - name: Check out repository
      uses: actions/checkout@v3

    - name: Config project
      run: |
        which vcpkg;
        cmake --preset debug_coro

    - name: Cppcheck
      run: cppcheck --project=build/debug_coro/compile_commands.json -i tests --error-exitcode=1 --check-level=exhaustive

    - name: Clang-format
      run: cmake --build build/debug_coro --target=check-format

    - name: Build
      run: cmake --build build/debug_coro -j `nproc`

    - name: Unit test with coroutine enabled
      run: ctest --test-dir build/debug_coro --output-on-failure -j 2
