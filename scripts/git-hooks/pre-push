#!/bin/bash
# LeanStore pre-push hook for AI-assisted development
# Runs full CI checks before pushing to ensure changes will pass CI

set -e

# Color codes
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${GREEN}=== LeanStore Pre-push CI Validation ===${NC}"

# Check if we should skip verification
if [ -n "$LEANSTORE_SKIP_PREPUSH" ]; then
    echo -e "${YELLOW}Skipping pre-push checks (LEANSTORE_SKIP_PREPUSH set)${NC}"
    exit 0
fi

# Get current branch
CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)

# Skip for main branch (protect it, but checks should be done in PR)
if [ "$CURRENT_BRANCH" = "main" ]; then
    echo -e "${YELLOW}On main branch. Skipping pre-push checks (use PR workflow).${NC}"
    exit 0
fi

# Check if ci-local-check.sh exists
if [ ! -f "./scripts/ci-local-check.sh" ]; then
    echo -e "${YELLOW}⚠ scripts/ci-local-check.sh not found. Skipping pre-push checks.${NC}"
    exit 0
fi

echo "Running CI validation before pushing to $CURRENT_BRANCH..."
echo "Checking files changed in this branch vs main..."

# Function to check if file is C/C++ source
is_cpp_file() {
    local file="$1"
    case "$file" in
        *.cpp|*.cc|*.c|*.h|*.hpp|*.hh)
            return 0
            ;;
        *)
            return 1
            ;;
    esac
}

# Find base branch for comparison
BASE_BRANCH=""
for candidate in "main" "origin/main" "upstream/main" "leanstore/main"; do
    if git rev-parse --verify "$candidate" >/dev/null 2>&1; then
        BASE_BRANCH="$candidate"
        break
    fi
done

# Check if there are any C/C++ files changed in this branch
HAS_CPP_FILES=0
if [ -n "$BASE_BRANCH" ]; then
    MERGE_BASE=$(git merge-base "$BASE_BRANCH" HEAD 2>/dev/null || echo "$BASE_BRANCH")
    CHANGED_FILES=$(git diff --name-only --diff-filter=ACM "$MERGE_BASE" HEAD 2>/dev/null || true)
    for file in $CHANGED_FILES; do
        if is_cpp_file "$file"; then
            HAS_CPP_FILES=1
            break
        fi
    done
fi

# If no C/C++ files changed, skip code checks
if [ $HAS_CPP_FILES -eq 0 ]; then
    echo -e "${GREEN}No C/C++ files changed in this branch. Skipping code quality checks.${NC}"
    exit 0
fi

# Run CI validation with branch mode (checks files changed vs main)
if ./scripts/ci-local-check.sh --mode branch > /tmp/pre-push-ci.log 2>&1; then
    echo -e "${GREEN}✅ All CI checks passed!${NC}"
    echo "Your changes should pass GitHub Actions CI."
    echo ""
    echo "Next steps:"
    echo "  1. Push your changes: git push origin $CURRENT_BRANCH"
    echo "  2. Check CI status: gh pr checks (if PR exists)"
    echo "  3. Monitor GitHub Actions for final validation"
else
    echo -e "${RED}❌ CI validation failed!${NC}"
    echo ""
    echo "Your changes would likely fail CI. Please fix the issues before pushing."
    echo ""
    echo "Common issues and fixes:"
    echo "  • Formatting: cmake --build build/debug_coro --target format"
    echo "  • Naming conventions: Check .clang-tidy rules"
    echo "  • Compilation errors: Check build output above"
    echo "  • Test failures: Run specific failing tests"
    echo ""
    echo "Full log available at: /tmp/pre-push-ci.log"
    echo "To skip this check (not recommended): LEANSTORE_SKIP_PREPUSH=1 git push"
    echo "Or run validation manually: ./scripts/ci-local-check.sh"
    exit 1
fi

exit 0